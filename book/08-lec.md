---
title: "Лекция 8. Группировка и сортировка полей в операторе SELECT"
layout: bookpage
lang: ru
navigation_weight: 8
---

# Лекция 8. Группировка и сортировка полей в операторе SELECT

## 8.1.	Предложения GROUP BY и HAVING

Пример. Необходимо решить следующую задачу: пусть в таблице Student содержится средний бал студентов (поле sr_ball), а имя группы (поле name) – в таблице Groups. Как получить средний бал группы?
Оператор, который начинает решать эту задачу будет выглядеть следующим обрарзом:
```sql
SELECT g.name AS 'Группа', s.sr_ball AS 'Средний балл' 
FROM Groups g, Student s
WHERE g.id = s.id_groups
```

Рассмотрим последовательно, работу этого оператора. Пусть существуют вот такие данные в таблицах:

| Таблица“Groups”|
| id | Name      |
| ---|-----------|
| 2  | 535       |
| 3  | 535a      | 

|              Таблица “Student”          |
| id | name        | sr_ball   | id_group |
| ---|-------------|-----------|----------| 
| 1  | Иванов      | 3,45      | 2        |
| 2  | Сидоров     | 4,24      | 2        |
| 3  | Петров      | 4,76      | 3        |
| 4  | Семенов     | 4,33      | 3        |



При выполнении данного SQL-оператора SELECT будут склеены поля name таблицы Groups и sr_ball таблицы Student и получен следующий результат:

| Группа | Средний балл   |
| -------|--------------- |
| 535    | 3,45           |
| 535    | 4,24           | 
| 535a   | 4,76           |
| 535а   | 4,33           | 



Можно заметить, что одни и те же значение поля name таблицы Groups многократно повторяются, представляя таким образом возможность для группирования данных. Внутри промежуточной таблицы появляются группы данных (они выделены жирными линиями), объединенные именем группы. 

Это позволяет произвести над значениями поля sr_ball, которое не является условием группировки, определенные арифметические действия, результатом которых является одна строка. К таким арифметическим действиям относятся операции вычисления количества записей, суммы значений, среднего арифметического, минимума, максимума и т.д. Функция AVG считает среднее арифметическое и результат работы SQL-оператора SELECT будет вот таким:


| Группа | Средний балл   |
| -------|--------------- |
| 535    | 3,845          |
| 535а   | 3,845          | 

Оператор, который решает эту задачу будет выглядеть так: 

```sql 
SELECT g.name AS 'Группа', AVG(s.sr_ball) AS 'Средний балл'
FROM Groups g, Student s 
WHERE g.id = s.id_groups 
GROUP BY g.name
```

Предложение GROUP BY SQL-оператора SELECT представляет механизм группировки полей по определенному условию. Предложение GROUP BY позволяет определять подмножество значений отдельного поля (s.sr_ball) в терминах другого поля (g.name) и применять функции агрегирования к полученному подмножеству. Это дает возможность комбинировать поля и агрегатные функции в одном предложении SELECT.

Пример. Пусть есть таблица `Usp (Id, Num - номер зачетки, Ocenka - оценка, Id_Sub - код предмета, Date - дата)`. Определить наименьшую оценку, полученную каждым студентом. (Интересует подмножество оценок по номерам зачеток, а потом к этому подмножеству оценок применяется функция MIN().)

`SELECT Num, MIN(Ocenka)`
 
`FROM Usp GROUP BY Num;`
Вывод для этого запроса имеет следующий вид:

| Num   |    |
| ------|--- |
| 3126  | 4  |
| 3124  | 5  | 
| 3125  | 3  |
| 3123  | 4  | 


Если требуется задать несколько полей, по которым выполняется группировка, то:
1.	Они	должны	быть	обязательно	заданы	в	предложении SELECT.
2.	они должны быть перечислены через запятую в предложении GROUP BY.
3.	при этом остальные поля предложения SELECT, которые не участвуют в группировке, обязательно должны быть заданы в  качестве параметров агрегатных функций.

Если заданное в предложении SELECT поле не является частью условия группировки и параметром агрегатной функции, то такой оператор считается ошибочным и не выполняется.
Пример. Пусть есть таблица Usp. Определить наименьшую оценку, полученную каждым студентом за каждый день.

```sql 
SELECT Num, Date, MIN(Ocenka) FROM Usp
GROUP BY Num, Date;
```

При работе с предложением GROUP BY сталкиваются с определенными сложностями. Основной ошибкой является неверное выделение поля или полей группировки. Чтобы правильно их выделить нужно мысленно выполнить первых две фазы оператора SELECT: склеивания полей и обработку условия WHERE.

Если предложение GROUP BY не задано, то автоматически производится группировка по всем полям, перечисленным в предложении SELECT. Это дает возможность выполнить агрегатные функции, над всем содержимым оператора SELECT таким образом, что каждая запись представляет единственную группу. Это бывает полезно в тех случаях, когда требуется, например, посчитать общее число записей в таблице.

```sql 
SELECT COUNT(*) FROM Student;
COUNT(*) --включает записи с NULL-значениями, а также дубликаты, по этой причине DISTINCT в данном случае не может быть использован.
```

# Предложение HAVING
 
Пример. Пусть есть таблица `Usp (Id, Num, Ocenka, Id_Sub, Date)`. Определить наименьшую оценку, полученную каждым студентом, выделить двоечников и троечников.

```sql 
SELECT Num, MIN(Ocenka) FROM Usp
GROUP BY Num
HAVING MIN(Ocenka) < 4(или HAVING MIN(Ocenka) IN (3, 2))
```

![](../assets/images/8-01.svg)

1.	Задано внутри  группы, которая была получена предложением GROUP BY;
2.	Должно ссылаться только на агрегатные функции и поля, выбранные в GROUP BY.
3.	HAVING может иметь только такие аргументы, у которых единственное значение для группы выходных данных.
4.	Для задания условий используются те же операции, что и в предложении WHERE. (Отличие состоит в том, что предложение WHERE выполняется перед группировкой и, следовательно, с ее помощью невозможно задать условие, которое использует результаты группировки. Кроме того, в предложение WHERE нельзя использовать агрегатные функции, потому что предикаты оцениваются в терминах одиночной строки, а агрегатные функции – групп строк.)
Пример. Получить средний бал групп, причем выводить список только тех групп, у которых средний балл выше 4,5.
Такое задание требует группировки и затем отсеивания некоторого количества результатов после ее выполнения:

```sql 
SELECT g.name AS 'Группа', AVG(s.sr_ball) AS 'Средний балл' FROM Groups g, Student s
WHERE g.id = s.id_group
GROUP BY g.name	HAVING AVG(s.sr_ball) > 4,5
``` 
В остальном способ задания и работа предложения HAVING
ничем не отличается от предложения WHERE.

## 8.2.	Предложение ORDER BY

SQL-оператор SELECT автоматически не выполняет сортировки данных. В SQL-операторе SELECT существует расположенное последним предложение ORDER BY, которое позволяет задать набор полей и порядок их сортировки.
Синтаксис предложения ORDER BY:
```sql 
ORDER BY имя_поля1[ ASC | DESC][, имя_поля2[ ASC | DESC], ...] 
```
 
(to ascend – подниматься, восходить, to descend – спускаться, сходить)

Особенности предложения ORDER BY:

1.	Параметр “имя_поля” задает поле предложения SELECT, по которому выполняется сортировка.
2.	Поля, по которым происходит упорядочивание, должны быть указаны в предложении SELECT.
3.	Ключевые слова ASC (по возрастанию) и DESC (по убыванию) определяют порядок (направление) сортировки. По умолчанию сортировка выполняется по возрастанию (ASC). Одновременно ASC и DESC заданы быть не могут.
4.	Если требуется сортировка не по одному, а по несколько полям, то они перечисляются через запятую. Причем для каждого поля можно задать направление сортировки.
5.	Если задано несколько полей, то поле, которое идет вначале, обладает преимуществом перед полем, которое задано после него.
6.	Имена полей при сортировке можно задавать одним из двух способов: - именами столбцов, - номерами столбцов.
Пример. Вывести список студентов отсортированный по возрастанию имен.

```sql
SELECT name AS 'Ф.И.О.' 
FROM Student 
ORDER BY name ASC
```


В данном случае ASC можно не указывать.
Пример. Информацию из таблицы с данными о студентах упорядочить по уменьшению размера стипендии (поле Stip), а для студентов, имеющих одинаковый ее размер – в алфавитном порядке их фамилий (поле Name).

```sql
SELECT * FROM Student 
ORDER BY Stip DESC, Name ASC;
```

Для указания полей, по которым упорядочиваются выходные данные, можно использовать их порядковые номера – номера столбцов в определении выходных данных оператора SELECT (а не столбцов в базовой таблице). То есть первое поле, имя которого указано в SELECT, является для предложения ORDER BY полем с номером 1, независимо от его расположения в базовой таблице.

Пример. Вывести список студентов отсортированный по именам. 

```sql
SELECT name AS 'Ф.И.О.', stip AS ‘Стипендия’ 
FROM Student 
ORDER BY 1 ASC
```

Если в поле, которое используется для упорядочения выходных данных, существуют NULL-значения, то все они следуют в конце или предшествуют всем остальным значениям этого поля. Конкретный вариант не оговаривается стандартом ANSI.
ORDER BY может использоваться с GROUP BY для упорядочения групп. ORDER BY всегда выполняется последней.
 
Пример. Пусть есть таблица `Usp (Id, Num, Ocenka, Id_Sub, Date)`. Определить наименьшую оценку, полученную каждым студентом, отсортировать по номерам зачеток.

```sql
SELECT Num, MIN(Ocenka) FROM Usp
GROUP BY Num ORDER BY Num;
```

Вывод для этого запроса имеет следующий вид:

| Num   |    |
| ------|--- |
| 3126  | 4  |
| 3124  | 5  | 
| 3125  | 3  |
| 3123  | 4  | 

До  этого	ные были сгруппированы, но порядок
групп был произвольным; теперь группы выстроены в определенной последовательности. Поскольку в команде ORDER BY не указан способ упорядочения, по умолчанию применяется возрастающий (ASC).

## 8.3.	Порядок выполнения предложений SQL-оператора SELECT

Понимание порядка обработки данных в SQL-операторе SELECT значительно упрощает его использование. Предложения всегда выполняются в том порядке, в котором они были заданы при описании оператора SELECT (рисунок 8.1). Именно поэтому у  пользователя есть возможность пропустить некоторые предложения, если они не нужны, но он не имеет права изменять порядок их определения.

![Схема выполнения предложений SQL-оператора SELECT](../assets/images/8-02.svg)

Рисунок 8.1 - Схема выполнения предложений SQL-оператора SELECT

Первым выполняется предложение SELECT, которое выбирает из таблицы значения всех полей таблиц, и формирует из них промежуточную таблицу в 1НФ. Существование DISTINCT влияет на содержимое этой таблицы, удаляя повторяющиеся записи.
Затем	промежуточная	таблица	поступает	в	предложение
WHERE, где просеивается сквозь условия.
 
Далее промежуточная таблица попадает в предложение GROUP BY, где выявляются группы и производятся заданные над ними действия. После этого результат поступает в предложение HAVING, которое может своим условием отсечь еще часть данных.
После этого результат сортируется согласно определениям предложения ORDER BY и поступает к пользователю.
Отсутствие одного из предложений WHERE, HAVING или ORDER BY приводит к пропуску данного этапа, что ускоряет обработку запроса пользователя. В SQL-операторе SELECT всегда выполняется группировка данных. Если предложение GROUP BY не заданно, то группировка автоматически проводится по всем полям.

**Контрольные вопросы**
 
1.	Каковы особенности использования предложения GROUP BY?
2.	Каковы особенности использования предложения HAVING?
3.	Каковы особенности использования предложения ORDER BY?
4.	Каков порядок выполнения предложений SQL-оператора SELECT?
