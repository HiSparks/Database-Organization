---
title: "Лекция 16: Средства журнализации и восстановления баз данных"
layout: bookpage
lang: ru
navigation_weight: 16
---
# 1. Буферизация блоков

Надежность – основное требование к БД = восстановление после сбоя.

Избыточная информация - журнал изменений базы данных.

Основа поддержания целостного состояния БД = механизм транзакций, журнализация и восстановление тесно связаны с понятием **транзакции**.

Принципы восстановления:

- результаты **зафиксированных** транзакций должны быть сохранены в восстановленном состоянии базы данных (т.е. должно поддерживаться свойство *долговечности* (*durability*) транзакций);

- результаты **незафиксированных** транзакций должны отсутствовать в восстановленном состоянии базы данных (в противном случае состояние базы данных могло бы оказаться не целостным).

Ситуации, требующие восстановления:

- *Индивидуальный откат* транзакции + ситуации, когда откат транзакции инициируется системой. Примеры -исключительная ситуации в прикладной программе (деление на ноль) или выбор транзакции в качестве жертвы при разрушении синхронизационного тупика.

- Для восстановления согласованного состояния базы данных при индивидуальном откате транзакции нужно устранить последствия операторов модификации базы данных, которые выполнялись в этой транзакции.

Ситуации, требующие восстановления:

- Восстановление после внезапной потери содержимого оперативной памяти (**мягкий сбой**). Аварийное выключение питания, неустранимого сбоя процессора (например, срабатывании контроля основной памяти) и т.д. Потеря той части БД, которая к моменту сбоя содержалась в буферах оперативной памяти СУБД.

- Восстановление после поломки основного внешнего носителя базы данных (**жесткий сбой**). Редко, но, тем не менее, СУБД должна быть в состоянии восстановить базу данных даже и в этом случае.

Основой восстановления является архивная копия и журнал изменений базы данных.

Буферизация блоков БД в основной памяти - способ достижения приемлемой эффективности СУБД (задержки процессора, памяти, дисков).

Механизм буферизации:

В случае СУБД, если при выполнении некоторой операции в некоторой транзакции требуется доступ к некоторому блоку БД, и копия этого блока *отсутствует в буферном пуле*, СУБД должна выделить какую-либо страницу буферного пула, считать в нее с диска требуемый блок базы данных и предоставить доступ к этой странице запросившей операции.

В стратегии замещения страниц буферного пула СУБД используется некоторая разновидность алгоритма LRU (Least Recently Used). - заменить страницу, к которой предположительно дольше всего не будет обращений

СУБД располагает *большей информацией* о страницах буферного пула, чем операционная система о страницах основной памяти (СУБД «знает», какой блок БД потребуется после завершения просмотра кортежей данного блока, и может заранее переместить его копию в некоторую страницу буферного пула).

СУБД использует алгоритм LRU с приоритетами страниц + поддерживается предварительное считывание в буферную память копий блоков, доступ к которым вскоре понадобится.

# 2. Индивидуальный откат транзакции

Транзакция - это неделимая, с точки зрения воздействия на СУБД, последовательность операций манипулирования данными.

Для пользователя транзакция выполняется по принципу "**все или ничего**", т.е. либо транзакция выполняется целиком и переводит базу данных из одного *целостного состояния* в другое *целостное состояние*.

Если по каким-либо причинам, одно из действий транзакции невыполнимо, или произошло какое-либо нарушение работы системы, база данных возвращается в исходное состояние, которое было до начала транзакции (происходит откат транзакции).

Для обеспечения возможности индивидуального отката транзакции по общему журналу все записи в журнале от данной транзакции связываются в обратный список.

В начале списка для незавершенных транзакций находится запись о последнем изменении базы данных, произведенном данной транзакцией.

Концом списка всегда служит первая запись об изменении базы данных, произведенном данной транзакцией.

В каждой записи проставляется уникальный идентификатор транзакции, чтобы можно было восстановить прямой список записей об изменениях базы данных данной транзакцией.

Процедура индивидуального отката транзакции:

- Выбирается *очередная* журнальная запись из списка данной транзакции.

- Выполняется *противоположная* по смыслу операция: вместо операции INSERT выполняется соответствующая операция DELETE, вместо операции DELETE выполняется INSERT, и вместо прямой операции UPDATE – обратная операция UPDATE, восстанавливающая предыдущее состояние объекта базы данных.

- Любая из этих обратных операций также *журнализуется*.

- При успешном завершении отката в журнал заносится *запись о конце транзакции*. С точки зрения журнала такая транзакция является зафиксированной.

# 3. Восстановление после сбоя

Проблема восстановления после **мягкого сбоя** - одна логическая операция изменения БД может изменять несколько физических блоков БД (блок данных и несколько блоков индексов).

Блоки БД буферизуются в оперативной памяти и выталкиваются *независимо*.

После мягкого сбоя набор блоков внешней памяти базы данных может оказаться несогласованным, т.е. часть блоков внешней памяти соответствует объекту до изменения, часть – после изменения.

Состояние внешней памяти БД называется *физически согласованным*, если наборы страниц всех объектов согласованы, т.е. соответствуют состоянию любого объекта либо после его изменения, либо до изменения

В журнале отмечаются *точки физической согласованности* БД – моменты времени, в которых во внешней памяти **содержатся** согласованные результаты операций, **завершившихся** до соответствующего момента времени, и **отсутствуют** результаты операций, которые **не завершились**.

Такая точка - **ppc** (*point of physical consistency*).

![](../assets/images/16_01.svg)

Возможные состояния транзакций к моменту мягкого сбоя

Процедура восстановление последнего по времени логически целостного состояния БД:

- Для транзакции T1 никаких действий производить не требуется. Она закончилась до момента tppc, и все ее результаты гарантированно отражены во внешней памяти БД.

- Для транзакции T2 нужно повторно выполнить последовательность операций, которые выполнялись после установки точки физически согласованного состояния в момент *tppc*. (во внешней памяти *отсутствуют* следы операций, которые выполнялись в транзакции T2 после момента *tppc*. Следовательно, **повторное прямое** (по смыслу и хронологии) выполнение операций транзакции T2 корректно и приведет к логически согласованному состоянию базы данных. )

- Для транзакции T3 нужно выполнить в обратном направлении (*undo*) ту часть операций, которую она успела выполнить до момента *tppc*. Действительно, во внешней памяти базы данных полностью отсутствуют результаты операций T3, которые были выполнены после момента *tppc*. С другой стороны, во внешней памяти гарантированно *присутствуют* результаты операций T3, которые были выполнены до момента *tppc*. Следовательно, **обратное выполнение** (по смыслу и хронологии) операций T3 корректно и приведет к согласованному состоянию базы данных. (Поскольку транзакция T3 не завершилась к моменту мягкого сбоя *tfs*, при восстановлении необходимо устранить все последствия ее выполнения.)

- Для транзакции T4, которая успела начаться после момента *tppc* и закончиться до момента мягкого сбоя tfs, нужно произвести **полное повторное прямое** выполнение операций. (Поскольку транзакция T4 успешно завершилась до момента мягкого сбоя *tfs*, в журнале *содержатся* записи обо всех изменениях базы данных, произведенных этой транзакцией).

- Для транзакции T5, **никаких действий** предпринимать не требуется. Результаты операций этой транзакции полностью отсутствуют во внешней памяти базы данных.

Восстановление последнего согласованного состояния БД после **жесткого сбоя**: использование логического журнала и архивной копии БД.

Процедура:

1. обратное копирования (на исправный носитель) БД из архивной копии;

2. по журналу в прямом направлении выполняются все операции;

3. для транзакций, которые не закончились к моменту сбоя, выполняется откат.

При утрате журнала: возврат к архивной копии БД. 
